<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!-- Create REPETITON Table -->
    <changeSet id="1-create-repetition-table" author="pavlinavasilevska">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="repetition"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE repetition (
                                        id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
                                        created_on TIMESTAMP WITHOUT TIME ZONE,
                                        uuid VARCHAR(255),
                                        frequency VARCHAR(255) NOT NULL,
                                        number_of_tries INTEGER NOT NULL,
                                        CONSTRAINT pk_repetition PRIMARY KEY (id)
            );
        </sql>
    </changeSet>

    <!-- Create ROLE Table -->
    <changeSet id="2-create-role-table" author="pavlinavasilevska">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="role"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE role (
                                  id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
                                  created_on TIMESTAMP WITHOUT TIME ZONE,
                                  uuid VARCHAR(255),
                                  role_name VARCHAR(255) NOT NULL,
                                  CONSTRAINT pk_role PRIMARY KEY (id)
            );

            ALTER TABLE role
                ADD CONSTRAINT uc_role_role_name UNIQUE (role_name);
        </sql>
    </changeSet>

    <!-- Create USERS Table -->
    <changeSet id="3-create-users-table" author="pavlinavasilevska">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="users"/>
            </not>
        </preConditions>

        <sql>
            CREATE TABLE users
            (
                id         BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
                created_on TIMESTAMP WITHOUT TIME ZONE,
                uuid       VARCHAR(255),
                username   VARCHAR(255),
                name       VARCHAR(255),
                surname    VARCHAR(255),
                email      VARCHAR(255)                            NOT NULL,
                password   VARCHAR(255)                            NOT NULL,
                CONSTRAINT pk_users PRIMARY KEY (id)
            );
        </sql>
    </changeSet>

    <!-- Create USER_ROLES Table -->
    <changeSet id="4-create-users-roles-table" author="pavlinavasilevska">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="user_roles"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE USER_ROLES (
                                        user_id INT NOT NULL,
                                        role_id INT NOT NULL,
                                        PRIMARY KEY (user_id, role_id),
                                        FOREIGN KEY (user_id) REFERENCES USERS(id) ON DELETE SET NULL,
                                        FOREIGN KEY (role_id) REFERENCES ROLE(id) ON DELETE CASCADE
            );
        </sql>
    </changeSet>

    <!-- Create EMAIL_TEMPLATE Table -->
    <changeSet id="5-create-email-template-table" author="pavlinavasilevska">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="email_template"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE email_template
            (
                id         BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
                created_on TIMESTAMP WITHOUT TIME ZONE,
                uuid       VARCHAR(255),
                subject    VARCHAR(255)                            NOT NULL,
                body       VARCHAR(255)                            NOT NULL,
                CONSTRAINT pk_email_template PRIMARY KEY (id)
            );
        </sql>
    </changeSet>

    <!-- Create EMAIL_JOB Table -->
    <changeSet id="6-create-email-job" author="pavlinavasilevska">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="email_job"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE email_job
            (
                id                BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
                created_on        TIMESTAMP WITHOUT TIME ZONE,
                uuid              VARCHAR(255),
                start_date        TIMESTAMP WITHOUT TIME ZONE             NOT NULL,
                end_date          TIMESTAMP WITHOUT TIME ZONE,
                enabled           BOOLEAN                                 NOT NULL,
                email_template_id BIGINT,
                sender_id         BIGINT,
                receivers         VARCHAR(255),
                repetition_id     BIGINT,
                CONSTRAINT pk_email_job PRIMARY KEY (id)
            );

            ALTER TABLE email_job
                ADD CONSTRAINT FK_EMAIL_JOB_ON_EMAIL_TEMPLATE FOREIGN KEY (email_template_id) REFERENCES email_template (id) ON DELETE CASCADE ;

            ALTER TABLE email_job
                ADD CONSTRAINT FK_EMAIL_JOB_ON_REPETITION FOREIGN KEY (repetition_id) REFERENCES repetition (id) ON DELETE CASCADE;

            ALTER TABLE email_job
                ADD CONSTRAINT FK_EMAIL_JOB_ON_SENDER FOREIGN KEY (sender_id) REFERENCES users (id) ON DELETE CASCADE;
        </sql>
    </changeSet>

    <!-- Create OCCURRENCE Table -->
    <changeSet id="7-create-occurrence-table" author="pavlinavasilevska">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="occurrence"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE occurrence
            (
                id                BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
                created_on        TIMESTAMP WITHOUT TIME ZONE,
                uuid              VARCHAR(255),
                status            VARCHAR(255),
                error_description VARCHAR(255),
                email_job_id      BIGINT                                  NOT NULL,
                CONSTRAINT pk_occurrence PRIMARY KEY (id),
                CONSTRAINT FK_OCCURRENCE_ON_EMAIL_JOB FOREIGN KEY (email_job_id) REFERENCES email_job (id) ON DELETE CASCADE
            );


        </sql>
    </changeSet>



</databaseChangeLog>