<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!-- Create EMAIL_JOB Table -->
    <changeSet id="1-create-email-job-table" author="pavlinavasilevska">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="email_job"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE email_job
            (
                id                BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
                created_on        TIMESTAMP WITHOUT TIME ZONE,
                uuid              VARCHAR(255),
                start_date        TIMESTAMP WITHOUT TIME ZONE             NOT NULL,
                end_date          TIMESTAMP WITHOUT TIME ZONE             NOT NULL,
                repetitive        BOOLEAN                                 NOT NULL,
                enabled           BOOLEAN                                 NOT NULL,
                email_template_id BIGINT,
                sender_id         BIGINT,
                receivers         VARCHAR(255),
                repetition_id     BIGINT,
                CONSTRAINT pk_email_job PRIMARY KEY (id)
            );

            ALTER TABLE email_job
                ADD CONSTRAINT FK_EMAIL_JOB_ON_EMAIL_TEMPLATE FOREIGN KEY (email_template_id) REFERENCES email_template (id);

            ALTER TABLE email_job
                ADD CONSTRAINT FK_EMAIL_JOB_ON_REPETITION FOREIGN KEY (repetition_id) REFERENCES repetiton (id);

            ALTER TABLE email_job
                ADD CONSTRAINT FK_EMAIL_JOB_ON_SENDER FOREIGN KEY (sender_id) REFERENCES users (id);
        </sql>
    </changeSet>

    <!-- Create OCCURRENCE Table -->
    <changeSet id="2-create-occurrence-table" author="pavlinavasilevska">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="occurrence"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE occurrence
            (
                id                BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
                created_on        TIMESTAMP WITHOUT TIME ZONE,
                uuid              VARCHAR(255),
                status            INTEGER,
                last_sent         TIMESTAMP WITHOUT TIME ZONE,
                error_description VARCHAR(255),
                email_job_id      BIGINT                                  NOT NULL,
                CONSTRAINT pk_occurrence PRIMARY KEY (id)
            );

            ALTER TABLE occurrence
                ADD CONSTRAINT FK_OCCURRENCE_ON_EMAIL_JOB FOREIGN KEY (email_job_id) REFERENCES email_job (id);
        </sql>
    </changeSet>

    <!-- Populate EMAIL_JOB Table -->
    <changeSet id="3-insert-into-email-job" author="pavlinavasilevska">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="2">
                    SELECT COUNT(*) FROM email_job;
                </sqlCheck>
            </not>
        </preConditions>
        <sql>
            INSERT INTO email_job (
                created_on, uuid, start_date, end_date, repetitive, enabled, email_template_id, sender_id, receivers, repetition_id
            ) VALUES
                  (
                      CURRENT_TIMESTAMP, 'uuid-email-job-1', '2024-08-01 08:00:00', '2024-08-31 08:00:00', true, true,
                      (SELECT id FROM email_template WHERE uuid = 'f4b68245-4c6b-4c5e-8b78-50e5e4d2e6da'),
                      (SELECT id FROM users WHERE username = 'admin'),
                      'example1@example.com, example2@example.com',
                      (SELECT id FROM repetiton WHERE uuid = 'sample-uuid-1')
                  ),
                  (
                      CURRENT_TIMESTAMP, 'uuid-email-job-2', '2024-08-01 09:00:00', '2024-08-31 09:00:00', false, true,
                      (SELECT id FROM email_template WHERE uuid = 'd26fc930-4bfa-4df9-9361-6e94fd798c3a'),
                      (SELECT id FROM users WHERE username = 'jdoe'),
                      'example3@example.com',
                      (SELECT id FROM repetiton WHERE uuid = 'sample-uuid-2')
                  );
        </sql>
    </changeSet>

    <!-- Populate OCCURRENCE Table -->
    <changeSet id="4-insert-into-occurrence" author="pavlinavasilevska">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="2">
                    SELECT COUNT(*) FROM occurrence;
                </sqlCheck>
            </not>
        </preConditions>
        <sql>
            INSERT INTO occurrence (
                created_on, uuid, status, last_sent, error_description, email_job_id
            ) VALUES
                  (
                      CURRENT_TIMESTAMP, 'uuid-occurrence-1', 0, '2024-07-30 08:00:00', 'Error in processing email job 1',
                      (SELECT id FROM email_job WHERE uuid = 'uuid-email-job-1')
                  ),
                  (
                      CURRENT_TIMESTAMP, 'uuid-occurrence-2', 1, '2024-07-30 09:00:00', 'Error in processing email job 2',
                      (SELECT id FROM email_job WHERE uuid = 'uuid-email-job-2')
                  );
        </sql>
    </changeSet>

</databaseChangeLog>
